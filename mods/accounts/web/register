#!/usr/bin/perl
# register
# Mike Perron (2013)
#
# Create a new entry in the accounts database.

use strict;
use DBI;

my $dbh = DBI->connect('dbi:mysql:kws', 'kraknet', '') or &fail("could not access DB");

my $postdata = <STDIN>;
my %postvalues;
my $reg_okay = 0;
my %okay;
my $pwhash;

if(length($postdata) > 0){
	my @pairs = split(/[;&]/, $postdata);
	foreach my $pair (@pairs){
		my ($name, $value) = split(/=/, $pair);
		$value =~ s/%([a-fA-F0-9][a-fA-F0-9])/pack("C", hex($1))/eg;
		$postvalues{$name} = $value; 
		chomp($postvalues{$name});
	}
}

# Rough estimate of acceptable domain names. Probably fine.
my $domain = $postvalues{domain};
if(!($domain =~ /^[a-zA-Z0-9.-]{3,}$/)){
	$domain = "";
}

$okay{name} = 1 if($postvalues{name} =~ /^[a-z\d_\-]{4,128}+$/);

if(($postvalues{pass} eq $postvalues{repass}) and (length($postvalues{pass}) >= 6)){
	$okay{pass} = 1;

	my $pass = $postvalues{pass};
	$pass =~ s/'/'"'"'/g;

	chomp($pwhash = qx/echo '$postvalues{name}$pass' | openssl sha512/);
	$pwhash =~ s/^.*\s([a-fA-F0-9]*)$/\1/g;
}

if(($okay{name} == 1) and ($okay{pass} == 1)){
	$reg_okay = 1;

	my $sql = qq/SELECT name FROM users WHERE name = ?;/;
	my $sth = $dbh->prepare($sql);
	$sth->execute($postvalues{name});

	if(!$sth->fetchrow_array()){
		$sql = qq/INSERT INTO users(name, hash, pretty) values(?, ?, ?);/;
		$sth = $dbh->prepare($sql);
		$sth->execute($postvalues{name}, $pwhash, $postvalues{name});
	} else {
		$reg_okay = 0;
	}
}

my $redir;
if($reg_okay == 1){
	printf "Status: 200 Registration OK\n";
	$redir = $postvalues{onsuccess};
	if($redir eq ""){
		$redir = "/";
	}

	# Registration worked, so there's no reason create_session should fail...right?
	printf "Set-Cookie: knetsid=" . qx/create_session '$postvalues{name}'/ . "; Path=/;" . ((length($domain) > 0) ? " Domain=$domain;" : "") . " Max-Age=5184000\n";

	print qq{Content-Type: text/html; charset=utf-8

<!DOCTYPE html>
<html><head>
	<title>Redirecting...</title>
	<meta http-equiv="refresh" content="0;$redir">
</head><body>
	<p>Redirecting you to <a href="$redir">$redir</a>...</p>
</body></html>
	};
} else {
	printf "Status: 200 Registration Failed\n";
	$redir = $postvalues{onfailure};
	if($redir eq ""){
		$redir = $ENV{HTTP_REFERER};
		if ($redir eq ""){
			$redir = "/";
		}
	}

	print qq{Content-Type: text/html; charset=utf-8

<!DOCTYPE html>
<html><head>
	<title>Redirecting...</title>
	<meta http-equiv="refresh" content="0;$redir">
</head><body>
	<p>Redirecting you to <a href="$redir">$redir</a>...</p>
</body></html>
	};
}

exit 0
